
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Extendiendo FormBuilder para añadir nuevos helpers personalizados - Gabriel Ortuño</title>
	<meta name="author" content="Gabriel Ortuño">

	
	<meta name="description" content="
	Extendiendo FormBuilder para añadir nuevos helpers personalizados
	A la hora de hacer nuevos formularios en rails siempre había echado de menos a...">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Gabriel Ortuño" type="application/atom+xml">
	<link rel="canonical" href="">
  <link href="/favicon.png" rel="shortcut icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">Gabriel Ortuño</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/blog">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/blog">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:http://arctarus.github.com">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		<a class="google" href="https://plus.google.com/arctarusnet@gmail.com?rel=author" title="Google+">Google+</a>
		
		
		<a class="twitter" href="http://twitter.com/arctarus" title="Twitter">Twitter</a>
		
		
		<a class="github" href="https://github.com/arctarus" title="GitHub">GitHub</a>
		
		
		
		
		<a class="delicious" href="http://delicious.com/arctarus" title="Delicious">Delicious</a>
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:http://arctarus.github.com">
	</form>
</nav>

</header>
	
		
<div id="banner" class="inner">
	<div class="container">
		<ul class="feed"></ul>
	</div>
	<small><a href="http://twitter.com/arctarus">arctarus</a> @ <a href="http://twitter.com">Twitter</a></small>
	<div class="loading">Loading...</div>
</div>
<script src="//javascripts/twitter.js"></script>
<script type="text/javascript">
	(function($){
		$('#banner').getTwitterFeed('arctarus', 4, false);
	})(jQuery);
</script>

	
	<div id="content" class="inner"><article class="post">
	<h1 class="title">Extendiendo FormBuilder para añadir nuevos helpers personalizados</h1>
	<div class="entry-content">A la hora de hacer nuevos formularios en rails siempre había echado de menos algún helper que te ayudara a incluir los típicos mensajes de error junto al campo al que se refieren para contextualizar cada uno de los mensajes, en lugar de que aparezcan todos listados en la cabecera del formulario.

La idea fundamental de lo que pretendía conseguir es la siguiente:
<a href="http://arctarus.files.wordpress.com/2011/03/form_error1.png"><img class="aligncenter size-full wp-image-429" title="ejemplo de errores en campos de formulario" src="http://arctarus.files.wordpress.com/2011/03/form_error1.png" alt="ejemplo de errores en campos de formulario" width="560" height="251" /></a>

Todo esto usando para ello un helper de FormBuilder para que el objeto concreto quede implícito y que el código resultante (en haml) nos quede como el siguiente:
<pre style="overflow:auto;">= form_for @user do |form|
   .field
      = form.label :name
      = form.error :p, :name
      = form.text:field :name</pre>
El primer parámetro indica el tag html que queremos usar como contenedor del error, y el segundo en atributo del modelo que debemos comprobar. Además, al tag contenedor le añadiremos la clase "error" de css para luego poder darle algunos estilos.

Tras dar algunas vueltas googleando me dí cuenta de que crear un nuevo helper no era tarea demasiado complicada, así que le eché un ojo a <a href="https://github.com/rails/rails/blob/master/actionpack/lib/action_view/helpers/form_helper.rb">FormHelper</a> y observé que está dividido en tres partes principales:
<ol>
	<li>El modulo FormHelper, que encapsula a todos los helpers de formularios.</li>
	<li>La clase FormBuilder, que es el resultado de usar el helper form_for y que contiene una instancia del objeto al que se refiere el formulario. Tiene métodos internos con el mismo nombre que los helpers que hacen uso de estos.</li>
	<li>La clase InstanceTag, que  es la encargada de generar el código para cada uno de los tags html. Es llamada desde los helpers.</li>
</ol>
Finalmente, adaptando un poco el código de otros helpers en el mismo fichero, el resultado fue:
<pre style="overflow:auto;">module ActionView
  module Helpers
    module FormHelper
      def error(object_name, tag_name, method, options = {})
        InstanceTag.new(object_name, method, self, options.delete(:object)).to_error_tag(tag_name)
      end
    end

    class InstanceTag
      def to_error_tag(tag_name)
      	unless @object.errors[@method_name].blank?
      	  content_tag tag_name, @object.errors[@method_name].first, :class =&gt; :error
      	end
      end
    end

    class FormBuilder
      def error(tag_name, method, options = {})
        @template.error(@object_name, tag_name, method, objectify_options(options))
      end
    end
  end
end</pre>
Que también se puede ver en <a title="extendiendo FormBuilder para añadir helpers personalizados" href="https://gist.github.com/849052">su gist correspondiente</a>.

&nbsp;

<strong>Actualización 22 de Marzo de 2011:</strong>

Otra forma de <a href="http://guides.rubyonrails.org/active_record_validations_callbacks.html#customizing-the-error-messages-html">personalizar los mensajes de error de los formularios en rails</a>, que acabo de ver en la guía de rails y que ya no recordaba, es usando ActionView::Base.field_error_proc. Simplemente se necesita asignarle un nuevo Proc que reciba el tag html y una instancia del modelo y listo. Podemos devolver lo que deseemos.
</div>


<div class="meta">
	<div class="date">








  


<time datetime="Liquid error: undefined method `xmlschema' for "2011-03-01 00:00:00 +0100":String" pubdate data-updated="true"></time></div>
	<div class="tags">


	blog


</div>
	
</div></article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	<a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
	
	
	<a class="addthis_button_tweet"></a>
	
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>


</div>
	<footer id="footer" class="inner">Copyright &copy; 2012

    Gabriel Ortuño

</footer>
	<script src="//javascripts/slash.js"></script>
<script src="//javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->






</body>
</html>